!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("gif.js/dist/gif.js"),require("webm-writer"),require("ffmpegserver.js/dist/ffmpegserver.js")):"function"==typeof define&&define.amd?define(["gif.js/dist/gif.js","webm-writer","ffmpegserver.js/dist/ffmpegserver.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).CCapture=e(t.GIF,t.WebMWriter,t.FFMpegServer)}(this,(function(t,e,i){"use strict";if(t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i,"gc"in window||(window.gc=function(){}),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,i){for(var n=atob(this.toDataURL(e,i).split(",")[1]),o=n.length,r=new Uint8Array(o),s=0;s<o;s++)r[s]=n.charCodeAt(s);t(new Blob([r],{type:e||"image/png"}))}}),
// @license http://opensource.org/licenses/MIT
"performance"in window==0&&(window.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in window.performance==0){var n=Date.now();performance.timing&&performance.timing.navigationStart&&(n=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-n}}function o(t){return String("0000000"+t).slice(-7)}function r(t){var e={};this.settings=t,this.on=function(t,i){e[t]=i},this.emit=function(t){var i=e[t];i&&i.apply(null,Array.prototype.slice.call(arguments,1))},this.filename=t.name||function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}(),this.extension="",this.mimeType=""}function s(e){r.call(this,e),e.quality=31-(30*e.quality/100||10),e.workers=e.workers||4,this.extension=".gif",this.mimeType="image/gif",this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.sizeSet=!1,this.encoder=new t({workers:e.workers,quality:e.quality,workerScript:e.workersPath+"gif.worker.js"}),this.encoder.on("progress",function(t){this.settings.onProgress&&this.settings.onProgress(t)}.bind(this)),this.encoder.on("finished",function(t){var e=this.callback;e&&(this.callback=void 0,e(t))}.bind(this))}function a(t){"image/webp"!==document.createElement("canvas").toDataURL("image/webp").substr(5,10)&&console.log("WebP not supported - try another export format"),r.call(this,t),this.quality=t.quality/100||.8,this.extension=".webm",this.mimeType="video/webm",this.baseFilename=this.filename,this.framerate=t.framerate,this.frames=0,this.part=1,this.videoWriter=new e({quality:this.quality,fileWriter:null,fd:null,frameRate:this.framerate})}function h(t){r.call(this,t),t.quality=t.quality/100||.8,this.encoder=new i.Video(t),this.encoder.on("process",function(){this.emit("process")}.bind(this)),this.encoder.on("finished",function(t,e){var i=this.callback;i&&(this.callback=void 0,i(t,e))}.bind(this)),this.encoder.on("progress",function(t){this.settings.onProgress&&this.settings.onProgress(t)}.bind(this)),this.encoder.on("error",function(t){alert(JSON.stringify(t,null,2))}.bind(this))}r.prototype.start=function(){},r.prototype.stop=function(){},r.prototype.add=function(){},r.prototype.save=function(){},r.prototype.dispose=function(){},r.prototype.safeToProceed=function(){return!0},r.prototype.step=function(){console.log("Step not set!")},s.prototype=Object.create(r.prototype),s.prototype.add=function(t){this.sizeSet||(this.encoder.setOption("width",t.width),this.encoder.setOption("height",t.height),this.sizeSet=!0),this.canvas.width=t.width,this.canvas.height=t.height,this.ctx.drawImage(t,0,0),this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step}),this.step()},s.prototype.save=function(t){this.callback=t,this.encoder.render()},a.prototype=Object.create(r.prototype),a.prototype.start=function(t){this.dispose()},a.prototype.add=function(t){this.videoWriter.addFrame(t),this.settings.autoSaveTime>0&&this.frames/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(t){this.filename=this.baseFilename+"-part-"+o(this.part),download(t,this.filename+this.extension,this.mimeType),this.dispose(),this.part++,this.filename=this.baseFilename+"-part-"+o(this.part),this.step()}.bind(this)):(this.frames++,this.step())},a.prototype.save=function(t){this.videoWriter.complete().then(t)},a.prototype.dispose=function(t){this.frames=0,this.videoWriter=new e({quality:this.quality,fileWriter:null,fd:null,frameRate:this.framerate})},h.prototype=Object.create(r.prototype),h.prototype.start=function(){this.encoder.start(this.settings)},h.prototype.add=function(t){this.encoder.add(t)},h.prototype.save=function(t){this.callback=t,this.encoder.end()},h.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};var c=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function l(t){var e,i=new Uint8Array(t);for(e=0;e<t;e+=1)i[e]=0;return i}var p={clean:l,pad:function(t,e,i){return t=t.toString(i||8),"000000000000".substr(t.length+12-e)+t},extend:function(t,e,i,n){var o=l((parseInt((e+i)/n)+1)*n);return o.set(t),o},stringToUint8:function(t,e,i){var n,o;for(e=e||l(t.length),i=i||0,n=0,o=t.length;n<o;n+=1)e[i]=t.charCodeAt(n),i+=1;return e},uint8ToBase64:function(t){var e,i,n,o,r=t.length%3,s="";for(e=0,n=t.length-r;e<n;e+=3)i=(t[e]<<16)+(t[e+1]<<8)+t[e+2],s+=c[(o=i)>>18&63]+c[o>>12&63]+c[o>>6&63]+c[63&o];switch(s.length%4){case 1:s+="=";break;case 2:s+="=="}return s}},u=[{field:"fileName",length:100},{field:"fileMode",length:8},{field:"uid",length:8},{field:"gid",length:8},{field:"fileSize",length:12},{field:"mtime",length:12},{field:"checksum",length:8},{field:"type",length:1},{field:"linkName",length:100},{field:"ustar",length:8},{field:"owner",length:32},{field:"group",length:32},{field:"majorNumber",length:8},{field:"minorNumber",length:8},{field:"filenamePrefix",length:155},{field:"padding",length:12}];const f={structure:u,format:function(t,e){var i=p.clean(512),n=0;return u.forEach((function(e){var o,r,s=t[e.field]||"";for(o=0,r=s.length;o<r;o+=1)i[n]=s.charCodeAt(o),n+=1;n+=e.length-o})),"function"==typeof e?e(i,n):i}};var d;function m(t){this.written=0,d=512*(t||20),this.out=p.clean(d),this.blocks=[],this.length=0}function g(t){r.call(this,t),this.extension=".tar",this.mimeType="application/x-tar",this.fileExtension="",this.baseFilename=this.filename,this.tape=null,this.count=0,this.part=1,this.frames=0}function w(t){g.call(this,t),this.type="image/png",this.fileExtension=".png"}function y(t){g.call(this,t),this.type="image/jpegs",this.fileExtension=".jpg",this.quality=t.quality/100||.8}function v(t){r.call(this,t),this.framerate=this.settings.framerate,this.type="video/webm",this.extension=".webm",this.stream=null,this.mediaRecorder=null,this.chunks=[]}m.prototype.append=function(t,e,i,n){var o,r,s,a,h,c,l;if("string"==typeof e)e=p.stringToUint8(e);else if(e.constructor!==Uint8Array.prototype.constructor)throw"Invalid input type. You gave me: "+e.constructor.toString().match(/function\s*([$A-Za-z_][0-9A-Za-z_]*)\s*\(/)[1];"function"==typeof i&&(i={}),s=(i=i||{}).mode||4095&parseInt("777",8),a=i.mtime||Math.floor(+new Date/1e3),h=i.uid||0,c=i.gid||0,o={fileName:t,fileMode:p.pad(s,7),uid:p.pad(h,7),gid:p.pad(c,7),fileSize:p.pad(e.length,11),mtime:p.pad(a,11),checksum:"        ",type:"0",ustar:"ustar  ",owner:i.owner||"",group:i.group||""},r=0,Object.keys(o).forEach((function(t){var e,i,n=o[t];for(e=0,i=n.length;e<i;e+=1)r+=n.charCodeAt(e)})),o.checksum=p.pad(r,6)+"\0 ",l=f.format(o);var u=512*Math.ceil(l.length/512),d=512*Math.ceil(e.length/512);this.blocks.push({header:l,input:e,headerLength:u,inputLength:d})},m.prototype.save=function(){var t=[],e=[],i=0,n=Math.pow(2,20),o=[];return this.blocks.forEach((function(t){i+t.headerLength+t.inputLength>n&&(e.push({blocks:o,length:i}),o=[],i=0),o.push(t),i+=t.headerLength+t.inputLength})),e.push({blocks:o,length:i}),e.forEach((function(e){var i=new Uint8Array(e.length),n=0;e.blocks.forEach((function(t){i.set(t.header,n),n+=t.headerLength,i.set(t.input,n),n+=t.inputLength})),t.push(i)})),t.push(new Uint8Array(1024)),new Blob(t,{type:"octet/stream"})},m.prototype.clear=function(){this.written=0,this.out=p.clean(d)},g.prototype=Object.create(r.prototype),g.prototype.start=function(){this.dispose()},g.prototype.add=function(t){var e=new FileReader;e.onload=function(){this.tape.append(o(this.count)+this.fileExtension,new Uint8Array(e.result)),this.settings.autoSaveTime>0&&this.frames/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(t){this.filename=this.baseFilename+"-part-"+o(this.part),download(t,this.filename+this.extension,this.mimeType);var e=this.count;this.dispose(),this.count=e+1,this.part++,this.filename=this.baseFilename+"-part-"+o(this.part),this.frames=0,this.step()}.bind(this)):(this.count++,this.frames++,this.step())}.bind(this),e.readAsArrayBuffer(t)},g.prototype.save=function(t){t(this.tape.save())},g.prototype.dispose=function(){this.tape=new m,this.count=0},w.prototype=Object.create(g.prototype),w.prototype.add=function(t){t.toBlob(function(t){g.prototype.add.call(this,t)}.bind(this),this.type)},y.prototype=Object.create(g.prototype),y.prototype.add=function(t){t.toBlob(function(t){g.prototype.add.call(this,t)}.bind(this),this.type,this.quality)},v.prototype=Object.create(r.prototype),v.prototype.add=function(t){this.stream||(this.stream=t.captureStream(this.framerate),this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.start(),this.mediaRecorder.ondataavailable=function(t){this.chunks.push(t.data)}.bind(this)),this.step()},v.prototype.save=function(t){this.mediaRecorder.onstop=function(e){var i=new Blob(this.chunks,{type:"video/webm"});this.chunks=[],t(i)}.bind(this),this.mediaRecorder.stop()};var b=window.Date.now();return function(t){var e,i,n,o,r,c,l,p=t||{},u=[],f=[],d=0,m=0,g=[],T=!1,k={};p.framerate=p.framerate||60,p.motionBlurFrames=2*(p.motionBlurFrames||1),e=p.verbose||!1,p.display,p.step=1e3/p.framerate,p.timeLimit=p.timeLimit||0,p.frameLimit=p.frameLimit||0,p.startTime=p.startTime||0;var j=document.createElement("div");j.style.position="absolute",j.style.left=j.style.top=0,j.style.backgroundColor="black",j.style.fontFamily="monospace",j.style.fontSize="11px",j.style.padding="5px",j.style.color="red",j.style.zIndex=1e5,p.display&&document.body.appendChild(j);var F,x,S=document.createElement("canvas"),O=S.getContext("2d");_("Step is set to "+p.step+"ms");var L={gif:s,webm:a,ffmpegserver:h,png:w,jpg:y,"webm-mediarecorder":v},q=L[p.format];if(!q)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(L).join(", ");(l=new q(p)).step=c,l.on("process",W),l.on("progress",(function(t){!function(t){var e=k[t];e&&e.apply(null,Array.prototype.slice.call(arguments,1))}("progress",t)}));var A=window.setTimeout,C=window.setInterval,E=window.clearInterval,I=window.clearTimeout,B=window.requestAnimationFrame,D=window.Date.now,M=window.performance.now,P=window.Date.prototype.getTime,R=[];function U(){T=!1,l.stop(),_("Capturer stop"),window.setTimeout=A,window.setInterval=C,window.clearInterval=E,window.clearTimeout=I,window.requestAnimationFrame=B,window.Date.prototype.getTime=P,window.Date.now=D,window.performance.now=M}function z(t,e){A(t,0,e)}function c(){z(W)}function W(){var t=1e3/p.framerate,e=(d+m/p.motionBlurFrames)*t;i=n+e,o=r+e,R.forEach((function(t){t._hookedTime=e/1e3})),function(){var t=d/p.framerate;(p.frameLimit&&d>=p.frameLimit||p.timeLimit&&t>=p.timeLimit)&&(U(),N());var e=new Date(null);e.setSeconds(t),p.motionBlurFrames>2?j.textContent="CCapture "+p.format+" | "+d+" frames ("+m+" inter) | "+e.toISOString().substr(11,8):j.textContent="CCapture "+p.format+" | "+d+" frames | "+e.toISOString().substr(11,8)}(),_("Frame: "+d+" "+m);for(var s=0;s<u.length;s++)i>=u[s].triggerTime&&(z(u[s].callback),u.splice(s,1));for(s=0;s<f.length;s++)i>=f[s].triggerTime&&(z(f[s].callback),f[s].triggerTime+=f[s].time);g.forEach((function(t){z(t,i-b)})),g=[]}function N(t){t||(t=function(t){return download(t,l.filename+l.extension,l.mimeType),!1}),l.save(t)}function _(t){e&&console.log(t)}return{start:function(){!function(){function t(){return this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime||0,this.pause(),R.push(this)),this._hookedTime+p.startTime}_("Capturer start"),n=window.Date.now(),i=n+p.startTime,r=window.performance.now(),o=r+p.startTime,window.Date.prototype.getTime=function(){return i},window.Date.now=function(){return i},window.setTimeout=function(t,e){var n={callback:t,time:e,triggerTime:i+e};return u.push(n),_("Timeout set to "+n.time),n},window.clearTimeout=function(t){for(var e=0;e<u.length;e++)u[e]!=t||(u.splice(e,1),_("Timeout cleared"))},window.setInterval=function(t,e){var n={callback:t,time:e,triggerTime:i+e};return f.push(n),_("Interval set to "+n.time),n},window.clearInterval=function(t){return _("clear Interval"),null},window.requestAnimationFrame=function(t){g.push(t)},window.performance.now=function(){return o};try{Object.defineProperty(HTMLVideoElement.prototype,"currentTime",{get:t}),Object.defineProperty(HTMLAudioElement.prototype,"currentTime",{get:t})}catch(t){_(t)}}(),l.start(),T=!0},capture:function(t){T&&(p.motionBlurFrames>2?(function(t){S.width===t.width&&S.height===t.height||(S.width=t.width,S.height=t.height,F=new Uint16Array(S.height*S.width*4),O.fillStyle="#0",O.fillRect(0,0,S.width,S.height))}(t),function(t){O.drawImage(t,0,0),x=O.getImageData(0,0,S.width,S.height);for(var e=0;e<F.length;e+=4)F[e]+=x.data[e],F[e+1]+=x.data[e+1],F[e+2]+=x.data[e+2];m++}(t),m>=.5*p.motionBlurFrames?function(){for(var t=x.data,e=0;e<F.length;e+=4)t[e]=2*F[e]/p.motionBlurFrames,t[e+1]=2*F[e+1]/p.motionBlurFrames,t[e+2]=2*F[e+2]/p.motionBlurFrames;for(O.putImageData(x,0,0),l.add(S),d++,m=0,_("Full MB Frame! "+d+" "+i),e=0;e<F.length;e+=4)F[e]=0,F[e+1]=0,F[e+2]=0;gc()}():c()):(l.add(t),_("Full Frame! "+ ++d)))},stop:U,save:N,on:function(t,e){k[t]=e}}}}));